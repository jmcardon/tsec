<html><head><title>TSec</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Jose Cardona" /><meta name="description" content="A Type-Safe General Cryptography Library on the JVM" /><meta name="og:image" content="/tsec/img/poster.png" /><meta name="og:title" content="TSec" /><meta name="og:site_name" content="TSec" /><meta name="og:url" content="https://jmcardon.github.io/tsec/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Type-Safe General Cryptography Library on the JVM" /><link rel="icon" type="image/png" href="/tsec/img/favicon.png" /><meta name="twitter:title" content="TSec" /><meta name="twitter:image" content="https://jmcardon.github.io/tsec/img/poster.png" /><meta name="twitter:description" content="A Type-Safe General Cryptography Library on the JVM" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/tsec/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/tsec/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/tsec/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/tsec/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/tsec/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/tsec/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/tsec/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/tsec/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/tsec/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/tsec/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/tsec/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/tsec/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/tsec/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/tsec/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/tsec/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/tsec/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/tsec/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/tsec/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/tsec/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/tsec/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/tsec/highlight/styles/default.css" /><link rel="stylesheet" href="/tsec/css/style.css" /><link rel="stylesheet" href="/tsec/css/palette.css" /><link rel="stylesheet" href="/tsec/css/codemirror.css" /><link rel="stylesheet" href="/tsec/css/kazari-style.css" /><link rel="stylesheet" href="/tsec/css/monokai.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/tsec/" class="brand"><div class="brand-wrapper"><span>TSec</span></div></a></li> <li><a href="/tsec/docs/symmetric.html" class="">Symmetric Ciphers</a></li> <li><a href="/tsec/docs/messagedigests.html" class="">Message Digests</a></li> <li><a href="/tsec/docs/passwordhashers.html" class="">Password Hashers</a></li> <li><a href="/tsec/docs/mac.html" class="">Message Authentication</a></li> <li><a href="/tsec/docs/signatures.html" class="">Digital Signatures</a></li> <li><a href="/tsec/docs/jwt-mac.html" class="">JWT</a></li> <li><a href="/tsec/docs/http4s-auth.html" class="">Http4s-Auth</a> <ul class="sub_section"> <li><a href="/tsec/docs/http4s-auth.html" class="">Overview</a></li> <li><a href="/tsec/docs/http4s/auth-scookie.html" class="">Signed Cookies</a></li> <li><a href="/tsec/docs/http4s/auth-ecookie.html" class="">Encrypted Cookies</a></li> <li><a href="/tsec/docs/http4s/auth-jwt.html" class="">JWT</a></li> <li><a href="/tsec/docs/http4s/auth-bearer.html" class="">Bearer Token</a></li> <li><a href="/tsec/docs/http4s/authorization.html" class="">Authorization</a></li> <li><a href="/tsec/docs/http4s/csrf.html" class="">CSRF</a></li></ul></li> <li><a href="/tsec/docs/common.html" class="">Common Utils</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/jmcardon/tsec"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/jmcardon/tsec"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('TSec A Type-Safe General Cryptography Library on the JVM');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('TSec A Type-Safe General Cryptography Library on the JVM');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="jmcardon" data-github-repo="tsec"><div class="content-wrapper"><section><h1 id="encrypted-cookie-authentication">Encrypted cookie authentication</h1>

<p>Encrypted cookie authenticator uses <code class="highlighter-rouge">TsecCookieSettings</code> for configuration:</p>
<div class="language-scala highlighter-rouge"><pre class="highlight"><code>  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">TSecCookieSettings</span><span class="o">(</span>
      <span class="n">cookieName</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"tsec-auth-cookie"</span><span class="o">,</span>
      <span class="n">secure</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
      <span class="n">httpOnly</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
      <span class="n">domain</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
      <span class="n">path</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
      <span class="n">extension</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
      <span class="n">expiryDuration</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">,</span>
      <span class="n">maxIdle</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">FiniteDuration</span><span class="o">]</span>
  <span class="o">)</span>
</code></pre>
</div>

<p>And for backing store, in the non-stateless case,  <code class="highlighter-rouge">AuthEncryptedCookie</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">AuthEncryptedCookie</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">Id</span><span class="o">](</span>
    <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span> <span class="c1">//The cookie id
</span>    <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="c1">//Cookie name. This is what the cookie will be sent as to your client
</span>    <span class="n">content</span><span class="k">:</span> <span class="kt">AEADCookie</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="c1">//The actual cookie content. This is a newtype over string. Coerce using `AEADCookie[A](rawString)`
</span>    <span class="n">messageId</span><span class="k">:</span> <span class="kt">Id</span><span class="o">,</span> <span class="c1">//Your user Id type. I.e for our example user class, this is Int
</span>    <span class="n">expiry</span><span class="k">:</span> <span class="kt">HttpDate</span><span class="o">,</span> <span class="c1">//The expiry time, as an HttpDate compatible with http4s
</span>    <span class="n">lastTouched</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">HttpDate</span><span class="o">],</span> <span class="c1">//Rolling window expiration time last touched.
</span>    <span class="n">secure</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span> <span class="c1">//TLS only?
</span>    <span class="n">httpOnly</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
    <span class="n">domain</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
    <span class="n">path</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
    <span class="n">extension</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
<span class="o">)</span>
</code></pre>
</div>

<p>This authenticator uses cookies as the underlying mechanism to track state, however, any information such as expiry, 
rolling window expiration or id is encrypted, as well as signed (AEAD encryption). 
This authenticator has both stateful and stateless (however users are currently checked with the backend).</p>

<ul>
  <li>Choose between one of AES128, AES192 or AES256 to perform your Authenticated Encryption with AES-GCM. 
<strong>Recommended default: AES128</strong>.</li>
  <li>User and token backing store as stated above, or just User store for stateless authenticator</li>
  <li>Can be vulnerable to <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a>, to be used with the CSRF middleware.</li>
  <li><a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> doesnâ€™t play nice with cookies.</li>
  <li>Your ID type for your user must have an <code class="highlighter-rouge">Encoder</code> and <code class="highlighter-rouge">Decoder</code> instance from circe</li>
</ul>

<h3 id="authenticator-creation">Authenticator creation</h3>
<p>If want want to create services, create a request handler as such:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">org.http4s.HttpService</span>
<span class="k">import</span> <span class="nn">org.http4s.dsl.io._</span>
<span class="k">import</span> <span class="nn">tsec.authentication._</span>
<span class="k">import</span> <span class="nn">tsec.cipher.symmetric.jca._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">EncryptedCookieExample</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">http4sExamples.ExampleAuthHelpers._</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">encryptor</span>   <span class="k">=</span> <span class="nc">AES128GCM</span><span class="o">.</span><span class="n">genEncryptor</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="n">unsafeRunSync</span><span class="o">()</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="n">gcmstrategy</span> <span class="k">=</span> <span class="nc">AES128GCM</span><span class="o">.</span><span class="n">defaultIvStrategy</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">cookieBackingStore</span><span class="k">:</span> <span class="kt">BackingStore</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">UUID</span>, <span class="kt">AuthEncryptedCookie</span><span class="o">[</span><span class="kt">AES128GCM</span>, <span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span>
    <span class="n">dummyBackingStore</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">UUID</span>, <span class="kt">AuthEncryptedCookie</span><span class="o">[</span><span class="kt">AES128GCM</span>, <span class="kt">Int</span><span class="o">]](</span><span class="k">_</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>

  <span class="c1">// We create a way to store our users. You can attach this to say, your doobie accessor
</span>  <span class="k">val</span> <span class="n">userStore</span><span class="k">:</span> <span class="kt">BackingStore</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="n">dummyBackingStore</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span>, <span class="kt">User</span><span class="o">](</span><span class="k">_</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">settings</span><span class="k">:</span> <span class="kt">TSecCookieSettings</span> <span class="o">=</span> <span class="nc">TSecCookieSettings</span><span class="o">(</span>
    <span class="n">cookieName</span> <span class="k">=</span> <span class="s">"tsec-auth"</span><span class="o">,</span>
    <span class="n">secure</span> <span class="k">=</span> <span class="kc">false</span><span class="o">,</span>
    <span class="n">expiryDuration</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">minutes</span><span class="o">,</span> <span class="c1">// Absolute expiration time
</span>    <span class="n">maxIdle</span> <span class="k">=</span> <span class="nc">None</span> <span class="c1">// Rolling window expiration. Set this to a FiniteDuration if you intend to have one
</span>  <span class="o">)</span>

  <span class="k">val</span> <span class="n">key</span><span class="k">:</span> <span class="kt">SecretKey</span><span class="o">[</span><span class="kt">AES128GCM</span><span class="o">]</span> <span class="k">=</span> <span class="nc">AES128GCM</span><span class="o">.</span><span class="n">unsafeGenerateKey</span> <span class="c1">//Our encryption key
</span>
  <span class="k">val</span> <span class="n">authWithBackingStore</span> <span class="k">=</span> <span class="c1">//Instantiate a stateful authenticator
</span>    <span class="nc">EncryptedCookieAuthenticator</span><span class="o">.</span><span class="n">withBackingStore</span><span class="o">(</span>
      <span class="n">settings</span><span class="o">,</span>
      <span class="n">cookieBackingStore</span><span class="o">,</span>
      <span class="n">userStore</span><span class="o">,</span>
      <span class="n">key</span>
    <span class="o">)</span>

  <span class="k">val</span> <span class="n">stateless</span> <span class="k">=</span> <span class="c1">//Instantiate a stateless authenticator
</span>    <span class="nc">EncryptedCookieAuthenticator</span><span class="o">.</span><span class="n">stateless</span><span class="o">(</span>
      <span class="n">settings</span><span class="o">,</span>
      <span class="n">userStore</span><span class="o">,</span>
      <span class="n">key</span>
    <span class="o">)</span>

  <span class="k">val</span> <span class="nc">Auth</span> <span class="k">=</span>
    <span class="nc">SecuredRequestHandler</span><span class="o">(</span><span class="n">stateless</span><span class="o">)</span>

  <span class="cm">/*
  Now from here, if want want to create services, we simply use the following
  (Note: Since the type of the service is HttpService[IO], we can mount it like any other endpoint!):
   */</span>
  <span class="k">val</span> <span class="n">service</span><span class="k">:</span> <span class="kt">HttpService</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Auth</span> <span class="o">{</span>
    <span class="c1">//Where user is the case class User above
</span>    <span class="k">case</span> <span class="n">request</span> <span class="k">@</span> <span class="nc">GET</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"api"</span> <span class="n">asAuthed</span> <span class="n">user</span> <span class="k">=&gt;</span>
      <span class="cm">/*
      Note: The request is of type: SecuredRequest, which carries:
      1. The request
      2. The Authenticator (i.e token)
      3. The identity (i.e in this case, User)
       */</span>
      <span class="k">val</span> <span class="n">r</span><span class="k">:</span> <span class="kt">SecuredRequest</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">User</span>, <span class="kt">AuthEncryptedCookie</span><span class="o">[</span><span class="kt">AES128GCM</span>, <span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">request</span>
      <span class="nc">Ok</span><span class="o">()</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/tsec/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/tsec/js/main.js"></script><script src="/tsec/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>